<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <title>test char js</title>
        <script src="chart.js"></script>
    </head>
    <body>
        <div style="width:800px;">
            <canvas id="myChart"></canvas>
        </div>
        <input type="date" id="debut">
        <input type="date" id="fin">

        <input type='file' accept='text/plain' onchange='openFile(event)'><br>
        <input type='button' value='update' onclick='update()'>
        <div id='output'>
        ...
        </div>


        <script type="text/javascript">
        var allDatas;
        var dotos = [];
        var tab = [1,2,3,4,5,6,7];
        var date = new Date(2018,11,16);
        console.log(date.getDay());




        var ctx = document.getElementById("myChart").getContext('2d');
        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"],
                datasets: [{
                    label: 'kW/h',
                    data: tab   ,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)',
                        'rgba(255, 159, 212, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255,99,132,1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(255, 159, 212, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero:true
                        }
                    }]
                }
            }
        });

            var tabUpdate = function() {
                var debut = (document.getElementById('debut').value).toString();
                var fin = (document.getElementById('fin').value).toString();
                var datas = periode(allDatas, debut, fin);
                var tabMois = decoupeMois(datas);
                console.log(tabMois);
            }

            var moisIncr = function(mois)
            {
                var m;
                if(typeof(mois) === 'string')
                {
                    console.log(typeof(mois));
                    m = parseInt(mois);
                }
                else {
                    m = mois;
                }


                if(m < 12)
                {
                    return m + 1;
                }
                else {
                    return 1;
                }
            }

            var formatDate = function(date) {
                var annee = date.slice(0,4);
                var mois = date.slice(5,7);
                var jour = date.slice(8,10);

                var res = annee + '/' + mois + '/' + jour;
                console.log(res);

                return res;
            }

            var decoupeMois = function(datas) {
                var tabMois = [];
                var temp = []
                var currentMois = (document.getElementById('debut').value).toString().slice(5,7);
                console.log(currentMois);

                for (var i = 0; i < datas.length; i++) {
                    if(datas[i]['mois'] == currentMois)
                    {
                        console.log("if");

                        temp.push(datas[i]);
                    }
                    else {
                        console.log("else");
                        tabMois.push(temp);
                        temp = [];
                        currentMois = moisIncr(currentMois);
                        temp.push(datas[i]);

                    }
                }
                tabMois.push(temp);
                return tabMois;
            }

            var openFile = function(event) {
                var input = event.target;

                var reader = new FileReader();
                reader.onload = function(){
                    var text = reader.result;
                    var node = document.getElementById('output');
                    var js = JSON.parse(text);
                    putZero(js['data']);
                    allDatas = js['data'];
                    tabUpdate();



                    dotos.push(stats(periode(js['data'],"2018/01/01","2018/01/31"))[2]);
                    dotos.push(stats(periode(js['data'],"2018/02/01","2018/02/30"))[2]);
                    dotos.push(stats(periode(js['data'],"2018/03/01","2018/03/31"))[2]);
                    dotos.push(stats(periode(js['data'],"2018/04/01","2018/04/30"))[2]);
                    dotos.push(stats(periode(js['data'],"2018/05/01","2018/05/31"))[2]);
                    dotos.push(stats(periode(js['data'],"2018/06/01","2018/06/30"))[2]);
                    dotos.push(stats(periode(js['data'],"2018/07/01","2018/07/31"))[2]);
                    //console.log(dotos);

                    myChart['config']['data']['datasets']['0']['data'] = dotos;
                    myChart.update();
                    };
                reader.readAsText(input.files[0]);



            };

            var stats = function (datas) {
                var somme = 0;
                var compt = 0;
                var moy = 0;
                var res = [];

                for (var d in datas) {
                    somme += parseInt(datas[compt]['valeur']);
                    compt++;
                }
                moy = somme/compt;
                res.push(somme);
                res.push(compt);
                res.push(moy);

                return res;
            };

            var periode = function (datas,debut,fin) {

                if(dateInfEgale(debut,fin)) {
                    var a1 = debut.slice(0,4);
                    var m1 = debut.slice(5,7);
                    var j1 = debut.slice(8,10);

                    var a2 = fin.slice(0,4);
                    var m2 = fin.slice(5,7);
                    var j2 = fin.slice(8,10);

                    var tab = [];
                    var cond = false;
                    var compt = 0;

                    for (var d in datas) {
                        if(datas[compt]['annee'] == a1 && datas[compt]['mois'] == m1 && datas[compt]['jour'] == j1)
                        {
                            cond = true;
                        }
                        else if(datas[compt]['annee'] == a2 && datas[compt]['mois'] == m2 && datas[compt]['jour'] == j2)
                        {
                            cond = false;
                        }

                        if(cond)
                        {
                            tab.push(datas[compt]);
                        }
                        compt++;
                    }
                    return tab;
                }
                else {
                    console.log("debut supérieur fin");
                    return new Error("debut supérieur fin");
                }
            };

            var dateInfEgale = function (debut,fin) {

                var a1 = debut.slice(0,4);
                var m1 = debut.slice(5,7);
                var j1 = debut.slice(8,10);

                var a2 = fin.slice(0,4);
                var m2 = fin.slice(5,7);
                var j2 = fin.slice(8,10);

                if(a1 < a2) {
                    return true;
                }
                else if(a1 == a2)
                {
                    if(m1 < m2) {
                        return true;
                    }
                    else if(m1 == m2)
                    {
                        if(j1 <= j2) {
                            return true;
                        }
                        else {
                            return false;
                        }
                    }
                    else {
                        return false;
                    }
                }
                else {
                    return false;
                }

            };

            var putZero = function (datas) {

                for (var i = 0; i < datas.length; i++) {
                    if(datas[i]['valeur'] == "-1")
                    {
                        datas[i]['valeur'] = "0";
                        console.log("test");
                    }
                }
            };



        </script>
    </body>
</html>

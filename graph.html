<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <title>test char js</title>
        <script src="chart.js"></script>
    </head>
    <body>
        <div style="width:800px;">
            <canvas id="myChart"></canvas>
        </div>
        <input type="date" id="debut">
        <input type="date" id="fin">

        <input type='file' accept='text/plain' onchange='openFile(event)'><br>
        <input type='button' value='update' onclick='update()'>
        <div id='output'>
        ...
        </div>


        <script type="text/javascript">
        var allDatas;
        var dotos = [];
        var tab = [1,2,3,4,5,6,7];
        var date = new Date(2018,00,16);







        var ctx = document.getElementById("myChart").getContext('2d');
        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"],
                datasets: [{
                    label: 'kW/h',
                    data: tab
                }]
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero:true
                        }
                    }]
                }
            }
        });

        var parseDateCal = function(dateCal) {
            var annee = dateCal.toString().slice(0,4);
            var mois = dateCal.toString().slice(5,7);
            var jour = dateCal.toString().slice(8,10);

            var res = new Date(annee,mois-1,jour);
            return res;

        };

        var tabUpdate = function() {
            var debut = parseDateCal(document.getElementById('debut').value);
            var fin = parseDateCal(document.getElementById('fin').value);
            var datas = periode(allDatas, debut, fin);
            var tabd = decoupeAnnee(datas);
            console.log(tabd);

            myChart['config']['data']['datasets']['0']['data'] = chartData(tabd,0);
            myChart['config']['data']['labels'] = chartLabel(tabd);
            myChart.update();

        }
        var chartData = function(datas,filtre) {
            var temp = [];
            var res = [];

            for (var i = 0; i < datas.length; i++) {
                temp = stats(datas[i])[filtre];
                res.push(temp);
            }
            return res;
        }

        var chartLabel = function(datas){
            var res = [];
            for (var i = 0; i < datas.length; i++) {
                res.push(i.toString());
            }
            console.log(res);
            return res;
        }


        var decoupeAnnee = function(datas) {
            var tabAnnee = [];
            var temp = [];
            var currentAnnee = parseDateCal(document.getElementById('debut').value).getFullYear();

            for (var i = 0; i < datas.length; i++) {
                if(datas[i]['annee'] == currentAnnee)
                {
                    console.log("if");
                    temp.push(datas[i]);
                }
                else {
                    console.log("else");
                    console.log(currentAnnee);
                    tabAnnee.push(temp);
                    temp = [];
                    currentAnnee += 1;
                    temp.push(datas[i]);

                }

            }
            tabAnnee.push(temp);
            return tabAnnee;

        }

        var openFile = function(event) {
            var input = event.target;


            var reader = new FileReader();
            reader.onload = function(){
                var text = reader.result;
                var node = document.getElementById('output');
                var js = JSON.parse(text);
                putZero(js['data']);
                allDatas = js['data'];
                tabUpdate();


                };
            reader.readAsText(input.files[0]);
        };

        var stats = function (datas) {
            var somme = 0;
            var compt = 0;
            var moy = 0;
            var res = [];

            for (var i=0; i<datas.length;i++) {
                somme += parseFloat(datas[i]['valeur']);
                compt++;
            }
            moy = somme/compt;
            res.push(somme);
            res.push(compt);
            res.push(moy);

            return res;
        };

        var periode = function (datas,debut,fin) {

            if(debut < fin) {
                var a1 = debut.getFullYear();
                var m1 = debut.getMonth()+1;
                var j1 = debut.getDay();

                var a2 = fin.getFullYear();
                var m2 = fin.getMonth()+1;
                var j2 = fin.getDay();

                var tab = [];
                var cond = false;
                var compt = 0;

                for (var d in datas) {
                    if(datas[compt]['annee'] == a1 && datas[compt]['mois'] == m1 && datas[compt]['jour'] == j1)
                    {
                        cond = true;
                    }
                    else if(datas[compt]['annee'] == a2 && datas[compt]['mois'] == m2 && datas[compt]['jour'] == j2)
                    {
                        cond = false;
                    }

                    if(cond)
                    {
                        tab.push(datas[compt]);
                    }
                    compt++;
                }
                return tab;
            }
            else {
                console.log("debut supérieur fin");
                return new Error("debut supérieur fin");
            }
        };

        var putZero = function (datas) {

            for (var i = 0; i < datas.length; i++) {
                if(datas[i]['valeur'] == "-1")
                {
                    datas[i]['valeur'] = "0";
                    console.log("test");
                }
            }
        };



        </script>
    </body>
</html>
